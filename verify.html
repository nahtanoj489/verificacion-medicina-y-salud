
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verificación de Incapacidad — Firma Digital</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:24px;color:#111}
    h1{font-size:22px;margin:0 0 6px}
    .mut{color:#555}
    .card{border:1px solid #cbd5e1;border-radius:8px;padding:14px;margin:12px 0}
    label{font-weight:600}
    input{padding:8px;border:1px solid #cbd5e1;border-radius:6px;width:100%}
    .row{display:flex;gap:10px;align-items:center}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .ok{color:#059669;font-weight:700}
    .bad{color:#b91c1c;font-weight:700}
    .warn{color:#b45309;font-weight:700}
    .small{font-size:12px;color:#555}
    button{padding:10px 14px;border-radius:6px;border:1px solid #0c4a6e;background:#0c4a6e;color:#fff;cursor:pointer}
    code{word-break:break-all}
  </style>
</head>
<body>
  <h1>Verificación de Incapacidad</h1>
  <div class="mut">Este verificador valida primero la <strong>firma digital de <code>ledger.json</code></strong> (ECDSA P‑256 + SHA‑256). Si la firma es válida, permite comprobar el <em>code</em> y <em>hash</em>.</div>

  <div class="card" id="sigBox">
    <div><strong>Estado de firma del libro (ledger.json):</strong> <span id="sigStatus">Verificando…</span></div>
    <div class="small">Usa <code>ledger-public.pem</code> y <code>ledger.sig</code> (Base64).</div>
  </div>

  <div class="card" id="formBox" style="display:none">
    <div class="grid">
      <div><label>Código</label><input id="code" placeholder="XXXX-XXXX-XXXX-XXXX"></div>
      <div><label>Huella (SHA-256)</label><input id="hash" placeholder="hex"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="verify">Verificar</button>
      <div id="status" style="margin-left:10px"></div>
    </div>
  </div>

  <div class="card" id="result" style="display:none">
    <div id="resultText"></div>
    <div class="small">Fuente: <code>ledger.json</code></div>
  </div>

<script>
  const pem2buf = (pem)=>{ const b64 = pem.replace(/-----[^-]+-----/g,'').replace(/\s+/g,''); const bin = atob(b64); const buf = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) buf[i]=bin.charCodeAt(i); return buf.buffer };
  async function verifyLedgerSig(){
    const sigStatus = document.getElementById('sigStatus');
    try{
      const [pemRes, sigRes, ledRes] = await Promise.all([
        fetch('ledger-public.pem', {cache:'no-store'}),
        fetch('ledger.sig', {cache:'no-store'}),
        fetch('ledger.json', {cache:'no-store'})
      ]);
      if(!pemRes.ok || !sigRes.ok || !ledRes.ok){ sigStatus.innerHTML = '<span class="bad">No se encontraron los archivos de firma</span>'; return null }
      const pem = await pemRes.text();
      const sigB64 = await sigRes.text();
      const ledgerText = await ledRes.text();

      const key = await crypto.subtle.importKey('spki', pem2buf(pem), {name:'ECDSA', namedCurve:'P-256'}, true, ['verify']);
      const sigBin = Uint8Array.from(atob(sigB64.replace(/\s+/g,'')), c=>c.charCodeAt(0));
      const enc = new TextEncoder();
      const ok = await crypto.subtle.verify({name:'ECDSA', hash:'SHA-256'}, key, sigBin, enc.encode(ledgerText));
      sigStatus.innerHTML = ok ? '<span class="ok">FIRMA VÁLIDA</span>' : '<span class="bad">FIRMA INVÁLIDA</span>';
      if(ok){ document.getElementById('formBox').style.display='block'; return JSON.parse(ledgerText) }
      return null;
    }catch(e){ sigStatus.innerHTML = '<span class="bad">Error verificando firma</span>'; return null }
  }

  async function main(){
    const ledger = await verifyLedgerSig();
    const verifyBtn = document.getElementById('verify');
    const status = document.getElementById('status');
    const result = document.getElementById('result');
    const resultText = document.getElementById('resultText');

    function getParam(name){ return new URL(location.href).searchParams.get(name)||'' }

    async function doVerify(){
      if(!ledger){ status.innerHTML = '<span class="warn">No puede verificarse porque la firma del ledger no es válida</span>'; return }
      const code = document.getElementById('code').value.trim();
      const hash = document.getElementById('hash').value.trim();
      status.textContent = 'Consultando…';
      const entry = (ledger.items||[]).find(x=> (x.code||'').toUpperCase()===code.toUpperCase());
      if(!entry){ status.innerHTML = '<span class="bad">No encontrado</span>'; result.style.display='none'; return }
      const ok = (entry.hash||'').toLowerCase() === hash.toLowerCase();
      status.innerHTML = ok ? '<span class="ok">VÁLIDO</span>' : '<span class="bad">NO VÁLIDO</span>';
      result.style.display='block';
      resultText.innerHTML = `
        <div><strong>Código:</strong> ${entry.code}</div>
        <div><strong>Fecha/Hora emisión:</strong> ${entry.issuedAt||'-'}</div>
        <div><strong>Lugar:</strong> ${entry.place||'-'}</div>
        <div><strong>Profesional:</strong> ${entry.issuer?.name||'-'} (RETHUS ${entry.issuer?.rethus||'-'})</div>
        <div><strong>Rango de incapacidad:</strong> ${entry.leave?.start||'-'} → ${entry.leave?.end||'-'} (${entry.leave?.days||'-'} días)</div>
        <div><strong>CIE-10:</strong> ${entry.leave?.dx||'-'}</div>
      `;
    }

    verifyBtn.addEventListener('click', doVerify);
    const qCode = getParam('code'); const qHash = getParam('hash');
    if(ledger && qCode && qHash){ document.getElementById('code').value=qCode; document.getElementById('hash').value=qHash; doVerify(); }
  }
  main();
</script>
</body>
</html>
